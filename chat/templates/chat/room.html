{% extends 'main/layout.html' %}
{% load static %}
{% block title %}Чат с пользователем{% endblock %}

{% block styles %}
    <link href="{% static 'chat/css/room.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
    <div class="col-lg-12">
        <div class="row rounded-lg overflow-hidden shadow-lg" id="chat_app">
            <!-- Users box-->
            <div class="col-5 px-0">
              <div class="bg-white">
                <div class="bg-gray px-4 py-2 bg-light">
                  <p class="h5 mb-0 py-1">Сообщения</p>
                </div>
                <div class="messages-box">
                  <div class="list-group rounded-0" id="conversations">

                  {% for dialog in dialogs_info %}
                      {% if dialog.dialog_message %}
                        <a href="{% url 'room' dialog.dialog_me dialog.dialog_other %}" class="list-group-item list-group-item-action rounded-0 {% if dialog.dialog_label == room_name %}active text-white{% else %}list-group-item-light{% endif %}">
                          <div class="media"><img src="{{ dialog.dialog_image_url }}" alt="user" width="50" height="50" class="rounded-circle">
                            <div class="media-body ml-4">
                              <div class="d-flex align-items-center justify-content-between mb-1">
                                <h6 class="mb-0">{{ dialog.dialog_user_first_name }}</h6><small class="small font-weight-bold">{{ dialog.dialog_message_timestamp }}</small>
                              </div>
                              <p class="font-italic {% if dialog.dialog_label == room_name %}{% else %}text-muted{% endif %} mb-0 text-small" id="{{ dialog.dialog_label }}">{{ dialog.dialog_message }}</p>
                            </div>
                          </div>
                        </a>
                      {% endif %}
                  {% endfor %}

                  </div>
                </div>
              </div>
            </div>
            <!-- Chat Box-->
            <div class="col-7 px-0">

            {% if other %}
                <div class="bg-gray px-4 py-2 bg-light">
                    <a href="{% url 'account:user_detail' other.username %}"><p class="h5 mb-0 py-1">{{ other.first_name }}</p></a>Был в сети: {{ other.last_login }}
                </div>
            {% endif %}

              <div class="px-4 py-5 chat-box bg-white" id="chat-box">

                  <!-- existed messages -->
                  {% for message in chat_messages %}
                      {% if message.user == request.user %}
                      <div class="media w-50 ml-auto mb-3">
                        <div class="media-body">
                            <div class="bg-primary rounded py-2 px-3 mb-2">
                                <p class="text-small mb-0 text-white" id="chat-log">
                                    {{ message.message }}
                                </p>
                            </div>
                            <p class="small text-muted">
                                {{ message.timestamp }}
                            </p>
                        </div>
                      </div>
                      {% else %}
                          <div class="media w-50 mb-3"><img src="{{ message.user.profile.image.url }}" alt="user" height="50" width="50" class="rounded-circle">
                            <div class="media-body">
                                <div class="bg-light rounded py-2 px-3 mb-2">
                                    <p class="text-small mb-0 text-muted" id="chat-log">
                                        {{ message.message }}
                                    </p>
                                </div>
                                <p class="small text-muted">
                                    {{ message.timestamp }}
                                </p>
                            </div>
                          </div>
                      {% endif %}
                  {% endfor %}
              </div>

              <!-- Typing area -->
              <div class="bg-light">
                <div class="input-group">
                  <input type="text" id="chat-message-input" placeholder="Введите сообщение" aria-describedby="button-addon2" class="form-control rounded-0 border-0 py-4 bg-light">
                  <div class="input-group-append">
                    <button id="chat-message-submit" type="submit" class="btn btn-link"> <i class="fa fa-paper-plane"></i></button>
                  </div>
                </div>
                {{ room_name|json_script:"room-name" }}
              </div>
            </div>
          </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.ReconnectingWebSocket=b()}(this,function(){function a(b,c,d){function l(a,b){var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,!1,!1,b),c}var e={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};d||(d={});for(var f in e)this[f]="undefined"!=typeof d[f]?d[f]:e[f];this.url=b,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var h,g=this,i=!1,j=!1,k=document.createElement("div");k.addEventListener("open",function(a){g.onopen(a)}),k.addEventListener("close",function(a){g.onclose(a)}),k.addEventListener("connecting",function(a){g.onconnecting(a)}),k.addEventListener("message",function(a){g.onmessage(a)}),k.addEventListener("error",function(a){g.onerror(a)}),this.addEventListener=k.addEventListener.bind(k),this.removeEventListener=k.removeEventListener.bind(k),this.dispatchEvent=k.dispatchEvent.bind(k),this.open=function(b){h=new WebSocket(g.url,c||[]),b||k.dispatchEvent(l("connecting")),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",g.url);var d=h,e=setTimeout(function(){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",g.url),j=!0,d.close(),j=!1},g.timeoutInterval);h.onopen=function(){clearTimeout(e),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onopen",g.url),g.protocol=h.protocol,g.readyState=WebSocket.OPEN,g.reconnectAttempts=0;var d=l("open");d.isReconnect=b,b=!1,k.dispatchEvent(d)},h.onclose=function(c){if(clearTimeout(e),h=null,i)g.readyState=WebSocket.CLOSED,k.dispatchEvent(l("close"));else{g.readyState=WebSocket.CONNECTING;var d=l("connecting");d.code=c.code,d.reason=c.reason,d.wasClean=c.wasClean,k.dispatchEvent(d),b||j||((g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onclose",g.url),k.dispatchEvent(l("close")));var e=g.reconnectInterval*Math.pow(g.reconnectDecay,g.reconnectAttempts);setTimeout(function(){g.reconnectAttempts++,g.open(!0)},e>g.maxReconnectInterval?g.maxReconnectInterval:e)}},h.onmessage=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",g.url,b.data);var c=l("message");c.data=b.data,k.dispatchEvent(c)},h.onerror=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onerror",g.url,b),k.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(b){if(h)return(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","send",g.url,b),h.send(b);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(a,b){"undefined"==typeof a&&(a=1e3),i=!0,h&&h.close(a,b)},this.refresh=function(){h&&h.close()}}return a.prototype.onopen=function(){},a.prototype.onclose=function(){},a.prototype.onconnecting=function(){},a.prototype.onmessage=function(){},a.prototype.onerror=function(){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a});</script>
    <script>
        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        let ws_scheme = window.location.protocol == 'https:' ? "wss" : 'ws';
        let chatSocket;
        if (roomName) {
            chatSocket = new ReconnectingWebSocket(
                `${ws_scheme}://`
                + window.location.host
                + `/${ws_scheme}/chat/`
                + roomName
                + '/'
            )
        }
        else {
            chatSocket = new ReconnectingWebSocket(
                `${ws_scheme}://`
                + window.location.host
                + `/${ws_scheme}/chat/`
            )
        }
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const dateOptions = {hour: 'numeric', minute: 'numeric', day: 'numeric', month: 'long'};
            const datetime = new Date(data['datetime']).toLocaleString("ru", dateOptions);
            const isMe = data.user === '{{ request.user }}';
            const image_url = data.image_url;
            let $chat = $('#chat-box');
            if(isMe) {
                $chat.append(
                    '<div class="media w-50 ml-auto mb-3">' +
                        '<div class="media-body">' +
                            '<div class="bg-primary rounded py-2 px-3 mb-2">' +
                                '<p class="text-small mb-0 text-white" id="chat-log">' +
                                    message +
                                '</p>' +
                            '</div>' +
                            '<p class="small text-muted">' +
                                datetime +
                            '</p>' +
                        '</div>' +
                    '</div>'
                );
            }
            else {
                $chat.append(
                    '<div class="media w-50 mb-3"><img src="' + image_url + '" alt="user" width="50" height="50" class="rounded-circle">' +
                        '<div class="media-body ml-3">' +
                            '<div class="bg-light rounded py-2 px-3 mb-2">' +
                                '<p class="text-small mb-0 text-muted" id="chat-log">' +
                                     message +
                                '</p>' +
                            '</div>' +
                            '<p class="small text-muted">' +
                                datetime +
                            '</p>' +
                        '</div>' +
                    '</div>'
                );
            }
            document.getElementById(`${roomName}`).textContent = message;
            $chat.scrollTop($chat[0].scrollHeight);
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>
{% endblock %}